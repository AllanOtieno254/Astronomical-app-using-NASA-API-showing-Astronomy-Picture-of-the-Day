<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpaceScholar â€” Learning & Quiz</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="img/mdb-favicon.ico" />

  <style>
    #bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: -1;
      opacity: 0.6;
    }

    /* Chatbot styles */
    #chatbot-icon {
      position: fixed;
      bottom: 30px; right: 30px;
      width: 70px; height: 70px;
      background-color: #0b3d91;
      color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    #chatbot-icon:hover { background-color: #1f5fe0; transform: scale(1.1); }

    #chatbot-container {
      display: none;
      flex-direction: column;
      position: fixed;
      bottom: 110px; right: 30px;
      width: 350px; height: 450px;
      background-color: #16213e;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      overflow: hidden;
      z-index: 999;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    #chatbot-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .bot, .user { max-width: 80%; padding: 10px 14px; border-radius: 20px; animation: bubble 0.3s ease-in-out; }
    .bot { background-color: #0b3d91; align-self: flex-start; color: #fff; }
    .user { background-color: #45a29e; align-self: flex-end; color: #fff; }

    @keyframes bubble { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

    #chatbot-input-container { display: flex; padding: 10px; border-top: 1px solid #0b3d91; background-color: #1f2833; }
    #chatbot-input { flex: 1; padding: 10px; border: none; border-radius: 20px; background-color: #0b0c10; color: #fff; outline: none; }
    #chatbot-send { background-color: #0b3d91; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 8px; cursor: pointer; color: white; }

    .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
    .option { transition: all .18s ease; }
    .option:hover { transform: translateY(-3px); }
  </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

  <!-- HEADER -->
  <header class="py-6">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="img/mdb-favicon.ico" alt="logo" class="w-10 h-10 rounded-full" />
        <h1 class="text-2xl font-bold">SpaceScholar â€” Learning Mode</h1>
      </div>
      <div class="flex items-center gap-3 text-slate-300">
        <select id="langSelect" class="rounded-md bg-slate-800 px-3 py-2 text-sm">
          <option value="auto">Language: Original</option>
          <option value="en">English</option>
          <option value="fr">FranÃ§ais</option>
          <option value="es">EspaÃ±ol</option>
          <option value="sw">Kiswahili</option>
        </select>
        <button id="saveLessonBtn" class="px-3 py-2 bg-amber-600 rounded-md text-slate-900 font-semibold">Save Lesson</button>
        <a href="index.html" class="px-3 py-2 border border-slate-700 rounded-md">Back</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-6">
    <video autoplay muted loop id="bg-video">
      <source src="./img/istockphoto-1270215944-640_adpp_is.mp4" type="video/mp4">
      Your browser does not support HTML5 video.
    </video>

    <!-- Left: APOD -->
    <section class="glass rounded-xl p-6 md:col-span-2">
      <div class="flex items-start gap-6">
        <div class="flex-1">
          <h2 id="apodTitle" class="text-2xl font-bold mb-1"></h2>
          <p id="apodDate" class="text-sm text-slate-400 mb-4"></p>
          <div id="mediaContainer" class="rounded-lg overflow-hidden bg-slate-800 w-full h-[50vh] grid place-items-center">
            <div id="mediaLoading" class="text-slate-400">Loading APODâ€¦</div>
          </div>
          <p id="apodExplanation" class="mt-4 text-slate-300 leading-relaxed"></p>

          <div class="mt-4 flex gap-3">
            <button id="toYoutubeBtn" class="px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700">Open NASA YouTube</button>
            <button id="generateQuizBtn" class="px-4 py-2 rounded-md border border-slate-700">Regenerate Quiz</button>
            <button id="viewWikiBtn" class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700">Contextual Wiki</button>
          </div>
        </div>
      </div>
      <div id="wikiResults" class="mt-6 glass rounded-lg p-4 hidden"></div>
    </section>

    <!-- Right: Quiz -->
    <aside class="glass rounded-xl p-6">
      <h3 class="text-lg font-semibold">Quiz</h3>
      <div class="mt-3">
        <div class="flex justify-between items-center">
          <div class="text-sm text-slate-400">Question <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
          <div class="text-sm text-emerald-400">Score: <span id="score">0</span></div>
        </div>
        <h4 id="questionText" class="mt-4 text-white font-medium"></h4>
        <div id="options" class="mt-4 grid gap-3"></div>
        <div class="mt-4 flex gap-2">
          <button id="prevQ" class="px-3 py-2 rounded-md border">Previous</button>
          <button id="nextQ" class="px-3 py-2 rounded-md border ml-auto">Next</button>
          <button id="endQuiz" class="px-3 py-2 rounded-md bg-rose-600 text-white">End & Results</button>
        </div>
        <div id="quizResult" class="mt-4 hidden p-3 rounded-md bg-slate-800"></div>
      </div>
    </aside>
  </main>

  <!-- CHATBOT -->
  <div id="chatbot-icon">ðŸ’¬</div>
  <div id="chatbot-container">
    <div id="chatbot-messages"></div>
    <div id="chatbot-input-container">
      <input type="text" id="chatbot-input" placeholder="Ask about space..." />
      <button id="chatbot-send">âž¤</button>
    </div>
  </div>

  <footer class="py-8 text-center text-slate-500">
    Â© SpaceScholar Learning
  </footer>

  <script>
    // NASA API fetch
    const NASA_API_KEY = "apIjpe3XDA1VOqgQ0KC2RTYmqz6T1pb0knrDaLay"; // Replace with actual key safely
    let APOD = null;

    async function fetchAPOD(date = "") {
      try {
        const url = `https://api.nasa.gov/planetary/apod?api_key=${NASA_API_KEY}${date ? `&date=${date}` : ""}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`NASA API ${res.status}`);
        const data = await res.json();
        APOD = data;
        renderAPOD(data);
      } catch (err) {
        document.querySelector("#mediaContainer").innerHTML =
          `<div class='text-rose-400'>Error: ${err.message}</div>`;
      }
    }

    function renderAPOD(data) {
      document.querySelector("#apodTitle").textContent = data.title || "APOD";
      document.querySelector("#apodDate").textContent = data.date;
      document.querySelector("#apodExplanation").textContent = data.explanation;

      const media = document.querySelector("#mediaContainer");
      if (data.media_type === "video") {
        const src = data.url.includes("watch?v=")
          ? data.url.replace("watch?v=", "embed/")
          : data.url;
        media.innerHTML = `<iframe src="${src}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
      } else {
        media.innerHTML = `<img src="${data.url}" alt="${data.title}" class="w-full h-full object-cover"/>`;
      }
    }

    fetchAPOD(); // auto-load today

    // Chatbot logic
    document.addEventListener("DOMContentLoaded", () => {
      const icon = document.getElementById("chatbot-icon");
      const container = document.getElementById("chatbot-container");
      const input = document.getElementById("chatbot-input");
      const send = document.getElementById("chatbot-send");
      const messages = document.getElementById("chatbot-messages");

      icon.addEventListener("click", () => {
        container.style.display = container.style.display === "flex" ? "none" : "flex";
      });

      send.addEventListener("click", handleMessage);
      input.addEventListener("keypress", (e) => { if (e.key === "Enter") handleMessage(); });

      function appendMessage(sender, text) {
        const div = document.createElement("div");
        div.className = sender;
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      async function handleMessage() {
        const userText = input.value.trim();
        if (!userText) return;
        appendMessage("user", userText);
        input.value = "";

        appendMessage("bot", "â‹¯");
        let response = await queryGemini(userText);
        messages.lastChild.remove();
        appendMessage("bot", response);
      }

      async function queryGemini(prompt) {
        const GEMINI_KEY = "AIzaSyAA0mTqF8IvW_jUp7WOsJ_fP6xtg9Xgir8";
        try {
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ role: "user", parts: [{ text: prompt }] }],
            }),
          });
          const data = await res.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure about that.";
        } catch {
          return "Network issue. Try again.";
        }
      }
    });
  </script>

</body>
</html>
